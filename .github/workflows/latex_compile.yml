name: Compile LaTeX Document

on: [push, pull_request]

jobs:
  compile_latex:
    runs-on: ubuntu-latest
    steps:
      - name: Set up TeX Live
        uses: xu-cheng/texlive-action@v2
        with:
          scheme: basic # Using basic scheme and will install packages manually
          texlive_version: 2023 # Use a specific year or 'latest' as per action's docs

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install LaTeX packages with tlmgr
        run: |
          echo "Starting LaTeX package installation..."
          tlmgr_path=$(find /usr/local/texlive -name tlmgr -type f -print -quit)
          if [ -z "$tlmgr_path" ]; then
            echo "Error: tlmgr not found. This shouldn't happen if TeX Live was set up correctly."
            exit 1
          fi
          echo "Found tlmgr at: $tlmgr_path"

          # Update tlmgr itself
          sudo $tlmgr_path update --self

          # Install necessary packages
          # scheme: basic is very minimal, so we need to install many common packages.
          # latexmk is a robust build tool.
          # biber is for bibliography.
          # The others are common LaTeX packages.
          echo "Installing core packages: latexmk, biber..."
          sudo $tlmgr_path install latexmk biber
          
          echo "Installing language and font packages: babel-french, inputenc, fontenc..."
          sudo $tlmgr_path install babel-french inputenc fontenc
          
          echo "Installing math and graphics packages: amsmath, amssymb, graphicx..."
          sudo $tlmgr_path install amsmath amssymb graphicx
          
          echo "Installing layout and utility packages: geometry, hyperref, biblatex..."
          sudo $tlmgr_path install geometry hyperref biblatex

          # Add any other specific packages your document might need
          # For example, if using specific fonts or complex diagrams:
          # sudo $tlmgr_path install <package1> <package2>

          echo "Finished installing LaTeX packages."

      - name: Compile LaTeX document
        id: compile
        run: |
          cd latex_paper_project
          # Using latexmk for robust compilation. It handles multiple runs and biber automatically.
          # Ensure compile_latex.py is adjusted or bypassed if latexmk is used directly here.
          # For now, keeping the python script:
          python compile_latex.py > ../../compilation_log.txt 2>&1
        continue-on-error: true

      - name: Create GitHub Issue on Failure
        if: steps.compile.outcome == 'failure'
        uses: JasonEtco/create-an-issue@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          filename: .github/latex_compilation_issue_template.md
          assignees: ${{ github.actor }}

      - name: Upload PDF artifact
        if: steps.compile.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: compiled-paper
          path: latex_paper_project/main.pdf

      - name: Upload Compilation Log on Failure
        if: steps.compile.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: compilation-log
          path: compilation_log.txt
