name: Compile LaTeX Document

on: [push, pull_request]

jobs:
  compile_latex:
    runs-on: ubuntu-latest
    steps:
      - name: Set up TeX Live
        uses: xu-cheng/texlive-action@v2
        with:
          scheme: basic # Using basic scheme and will install biber and other needed packages manually
          texlive_version: 2023 # Or latest
          packages: biber latexmk chktex # latexmk for robust compilation, chktex for linting (optional)
          # Add other specific packages if main.tex requires them and they are not in basic scheme + biber

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install additional LaTeX packages
        run: |
          sudo apt-get update
          # Install packages that might be missing from texlive basic for the current document
          # This is a common requirement for specific fonts or complex packages.
          # For this project, babel-french, inputenc, fontenc, amsmath, amssymb, graphicx, geometry, hyperref should be covered by a reasonable scheme.
          # However, let's ensure common ones are there if not in 'basic' + 'biber'.
          # tlmgr might also be used here if preferred: tlmgr install <package>
          # For now, assuming xu-cheng/texlive-action with 'scheme: basic' + 'packages: biber' handles most,
          # but if errors occur, specific missing .sty files would need to be installed here.
          # Example: sudo apt-get install -y texlive-lang-french texlive-latex-extra
          # The texlive-action installs a fairly complete TeXLive, so specific apt-get might not be needed
          # Let's rely on the 'packages' option of texlive-action first.
          # Add a step to install specific packages for French language support if not covered
          tlmgr_path=$(find /usr/local/texlive -name tlmgr -type f -print -quit)
          if [ -z "$tlmgr_path" ]; then echo "tlmgr not found"; exit 1; fi
          sudo $tlmgr_path update --self
          # Essential packages for the document (some might be included in 'scheme: basic')
          sudo $tlmgr_path install babel-french inputenc fontenc amsmath amssymb graphicx geometry hyperref biblatex # Add any other specific packages
          echo "Finished installing additional LaTeX packages."


      - name: Compile LaTeX document
        id: compile
        run: |
          cd latex_paper_project
          python compile_latex.py > ../../compilation_log.txt 2>&1
        continue-on-error: true # Allow the job to continue to the issue creation step

      - name: Create GitHub Issue on Failure
        if: steps.compile.outcome == 'failure'
        uses: JasonEtco/create-an-issue@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          filename: .github/latex_compilation_issue_template.md
          assignees: ${{ github.actor }} # Assigns the user who triggered the workflow
          # Update issue title and body to be more dynamic if possible
          # The template file will help structure the issue.

      - name: Upload PDF artifact
        if: steps.compile.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: compiled-paper
          path: latex_paper_project/main.pdf

      - name: Upload Compilation Log on Failure
        if: steps.compile.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: compilation-log
          path: compilation_log.txt
